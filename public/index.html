<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dining philosophers problem</title>
  </head>
  <body>
    <svg width="1200" height="1200">
      <g class="table"></g>
      <g class="chairs"></g>
      <g class="plates"></g>
      <g class="forks"></g>
    </svg>

    <input type="number" />
  </body>

  <script type="module">
    import * as d3 from 'https://cdn.skypack.dev/d3@7'
    // let socket = new WebSocket('ws://localhost:3000')
    // socket.onopen = () => socket.send('start')

    // socket.onmessage = event => {
    // TODO: Add some error handling here
    // const message = JSON.parse(event.data)

    const philosophers = Array(5).fill(null)

    var svg = d3.select('body').attr('width', 1200).attr('height', 1200)

    const tableSize = 80 * (philosophers.length / 3)
    // TODO: Get screen size and center it?
    const tableY = 300
    const tableX = 300

    const chairMargin = 90 * (philosophers.length / 3)
    const chairSize = 40

    // TODO: Check margins in more extreme cases.
    const plateSize = 20
    const plateMargin = 50 * (philosophers.length / 3)

    const calcX = (margin, radius) => (d, i) =>
      tableX +
      (margin + radius) * Math.sin(i * 2 * (Math.PI / philosophers.length))

    const calcY = (margin, radius) => (d, i) =>
      tableY +
      (margin + radius) * Math.cos(i * 2 * (Math.PI / philosophers.length))

    // Draw philosopher chairs
    const chairs = d3
      .select('.chairs')
      .selectAll('circle')
      .data(philosophers)
      .enter()
      .append('circle')
      .attr('cy', calcY(chairMargin, chairSize))
      .attr('cx', calcX(chairMargin, chairSize))
      .attr('r', chairSize)
      .attr('fill', 'dodgerblue')

    // Draw table
    const table = d3
      .select('.table')
      .append('circle')
      .attr('cy', tableY)
      .attr('cx', tableX)
      .attr('r', tableSize)
      .attr('fill', 'tomato')

    // Draw plates
    const plates = d3
      .select('.plates')
      .selectAll('circle')
      .data(philosophers)
      .enter()
      .append('circle')
      .attr('cy', calcY(plateMargin, plateSize))
      .attr('cx', calcX(plateMargin, plateSize))
      .attr('r', plateSize)
      .attr('fill', 'beige')

    // Draw forks
    const forks = d3
      .select('.forks')
      .selectAll('rect')
      .data(philosophers)
      .enter()
      .append('g')
      .append('rect')
      .attr('x', calcX(plateMargin, plateSize))
      .attr('y', calcY(plateMargin, plateSize))
      .attr('width', 9)
      .attr('height', 30)
      .attr(
        'transform',
        (d, i) =>
          `rotate(${
            (philosophers.length - i) * (360 / philosophers.length)
          }, ${calcX(plateMargin, plateSize)(d, i)} ${calcY(
            plateMargin,
            plateSize
          )(d, i)})`
      )
      .attr('fill', 'brown')

    d3.select('.forks').attr('transform', `rotate(-20, ${tableX}, ${tableY})`)
    // }
  </script>
</html>
